# Bill Sacks
# August, 2012

# This documents the procedure for regridding the Bamber Greenland
# landcover data to 30" resolution, so that it can be merged with Alex
# Gardner's glacier cover dataset.

# This file and any associated scripts can be found here:

# https://svn-user-sacks.cgd.ucar.edu/cism_misc/regrid_bamber_to_30sec/trunk

# The various intermediate files can be found on roo:
# ~/cism_misc/regrid_bamber_to_30sec

# ----------------------------------------------------------------------
# Create template file for output
# ----------------------------------------------------------------------

# We want the final output file to have the coordinates and bounds of
# "tile B" from the GLOBE topography dataset. This is a 30" file with
# bounds of 50 - 90N, -90 to 0E. (Resulting array should be 10800 x
# 4800.)

# (Did the following on mirage, because it didn't work on roo)

# (The input file came from Jeremy Fyke:
# GLOBE_glacier_mask/Gardner_ice_mask_data/ASG_ice_shelf_0.0083.nc)

ncks -d lat,50.,90. -d lon,-90.,0. ASG_ice_shelf_0.0083.nc template_out.nc
ncwa -O -a time template_out.nc template_out2.nc
mv template_out2.nc template_out.nc
ncrename -v 'ice shelf',ice_shelf template_out.nc

# convert to netcdf3 format (needed for ncl on mirage)
ncap2 -O -s 'ice_shelf=byte(ice_shelf)' template_out.nc template_out.nc
ncks -O -3 template_out.nc template_out.nc

# the template file mistakenly had dimensions ordered (lon,lat) rather
# than (lat,lon); need to fix that
ncpdq -a lat,lon template_out.nc template_out2.nc
mv template_out2.nc template_out.nc

# ----------------------------------------------------------------------
# Convert Bamber landcover to continuous fields, and do other
# modifications to get Bamber data ready for interpolation
# ----------------------------------------------------------------------

# Extract desired fields
# Note that this uses the file with my fixed landcover variable
ncks -v lat,lon,landcover,usrf,mapping ../fixing_greenland_data/Greenland_5km_v1.1_SacksRev_c110629.nc bamber_5km.nc

# Remove degenerate time dimension
ncwa -O -a time bamber_5km.nc bamber_5km.nc

# Add fill value attribute to usrf
ncatted -a _FillValue,usrf,c,f,-9999. bamber_5km.nc

# Convert to continuous fields: % icesheet, % gic. Also, create landmask variable
ncap2 -S convert_bamber_fields.ncap2 bamber_5km.nc bamber_5km_converted.nc

# ----------------------------------------------------------------------
# Make a version of bamber_5km_converted for plotting in panoply
# ----------------------------------------------------------------------

# For some reason, panoply doesn't properly handle the 'mapping';
# first we need to get rid of that
ncks -x -v mapping bamber_5km_converted.nc bamber_5km_converted_plotting.nc 
ncatted -a grid_mapping,,d,, bamber_5km_converted_plotting.nc

# Now we need to add attributes pointing panoply to the lat & lon arrays
ncatted -a coordinates,,c,c,'lon lat' bamber_5km_converted_plotting.nc
# But those attributes don't apply to non-spatial variables
ncatted -a coordinates,time,d,, -a coordinates,x1,d,, -a coordinates,y1,d,, bamber_5km_converted_plotting.nc

# ----------------------------------------------------------------------
# Fill (extrapolate) missing values, to make for improved interpolation
# ----------------------------------------------------------------------

# Purpose: without this step, there is an encroachment of missing
# values when doing bilinear interpolation. That encroachment of
# missing values would lead to bad results along coastlines if we used
# this file to generate a surface dataset at high resolution. Doing
# extrapolation isn't ideal, but I think it's the lesser of two evils.

cp bamber_5km_converted.nc bamber_5km_converted_filled.nc
ncl fill_missing.ncl

# ----------------------------------------------------------------------
# And make a version of that file for plotting in panoply, too
# ----------------------------------------------------------------------

# For some reason, panoply doesn't properly handle the 'mapping';
# first we need to get rid of that
ncks -x -v mapping bamber_5km_converted_filled.nc bamber_5km_converted_filled_plotting.nc 
ncatted -a grid_mapping,,d,, bamber_5km_converted_filled_plotting.nc

# Now we need to add attributes pointing panoply to the lat & lon arrays
ncatted -a coordinates,,c,c,'lon lat' bamber_5km_converted_filled_plotting.nc
# But those attributes don't apply to non-spatial variables
ncatted -a coordinates,time,d,, -a coordinates,x1,d,, -a coordinates,y1,d,, bamber_5km_converted_filled_plotting.nc

# ----------------------------------------------------------------------
# Interpolate to 30" grid
# ----------------------------------------------------------------------

# This interpolation is done using NCL's new ESMF_regrid function,
# using bilinear interpolation

# Did the following on mirage (because the ESMF_regridWeightGen
# program isn't working on roo):
# Note: if rerunning this, may have to change skip_src_grid,
# skip_dst_grid and skip_wgt_grid
# Time requirement: a few hours to create source & dest grid files &
# weight files; a few minutes to regrid
nohup ncl regrid.ncl > nohup.out &

# ----------------------------------------------------------------------
# Convert landmask to 0/1
# ----------------------------------------------------------------------

ncap2 -s 'where(landmask > 0) landmask=1; landmask=byte(landmask)' bamber_30sec.nc bamber_30sec_landmask.nc

mv bamber_30sec_landmask.nc bamber_30sec.nc

# ----------------------------------------------------------------------
# Compute derived quantities
# ----------------------------------------------------------------------

ncap2 -s 'pct_landice = pct_gic + pct_icesheet' bamber_30sec.nc bamber_30sec_derived.nc

rm bamber_30sec.nc
ncks -x -v pct_icesheet bamber_30sec_derived.nc bamber_30sec.nc
rm bamber_30sec_derived.nc
